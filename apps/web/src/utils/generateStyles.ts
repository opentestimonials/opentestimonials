import { Processor } from 'windicss/lib';
import { HTMLParser } from 'windicss/utils/parser';
import aspectRatioPlugin from 'windicss/plugin/aspect-ratio';

export function generateStyles(html: string, preflight = false) {
  // Get windi processor
  const processor = new Processor({
    plugins: [aspectRatioPlugin],
  });

  // Parse all classes and put into one line to simplify operations
  const htmlClasses = new HTMLParser(html)
    .parseClasses()
    .map((i) => i.result)
    .join(' ');

  // Generate preflight based on the HTML we input
  const preflightSheet = processor.preflight(html);

  // Process the HTML classes to an interpreted style sheet
  const interpretedSheet = processor.interpret(htmlClasses).styleSheet;

  // Build styles

  // we don't need preflight!
  const APPEND = false;
  const MINIFY = true;
  if (preflight) {
    const withPreflightStyles = interpretedSheet
      .extend(preflightSheet, APPEND)
      .build(MINIFY);
    return withPreflightStyles;
  }
  const styles = interpretedSheet.build(MINIFY);
  return styles;
}
