import ExpandableTestimonials from '@/components/opentestimonials/ExpandableTestimonials';
import { ENV } from '@/utils/env';
import fetch from 'cross-fetch';
import { NextApiRequest, NextApiResponse } from 'next';
import invariant from 'tiny-invariant';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const subdomain = req.query.subdomain;
    invariant(typeof subdomain === 'string', 'invalid subdomain');
    const html = await fetch(
      `${ENV.get('SERVER_URL')}/embed/expandable/${subdomain}`
    ).then((r) => r.text());

    const withAbsoluteImagePaths = html.replaceAll(
      '/_next/image',
      `${ENV.get('SERVER_URL')}/_next/image`
    );

    console.log(withAbsoluteImagePaths);

    const foo = (
      <ExpandableTestimonials
        subdomain={subdomain}
        style={{ height: '100vh' }}
      />
    );

    console.log(foo);

    res
      .status(200)
      .setHeader(
        'Cache-control',
        's-maxage=1, stale-while-revalidate=3154000000'
      )
      .setHeader('Accept-Encoding', 'gzip')
      .setHeader('Access-Control-Allow-Origin', '*')
      .send(withAbsoluteImagePaths);
  } catch (e) {
    console.error('Failed to render', e);
  }
}
