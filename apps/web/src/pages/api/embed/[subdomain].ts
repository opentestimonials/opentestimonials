import { ENV } from '@/utils/env';
import { generateStyles } from '@/utils/generateStyles';
import fetch from 'cross-fetch';
import { JSDOM } from 'jsdom';
import { NextApiRequest, NextApiResponse } from 'next';
import invariant from 'tiny-invariant';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const subdomain = req.query.subdomain;
    const styles =
      typeof req.query.styles === 'string' ? req.query.styles === 'true' : true;
    invariant(typeof subdomain === 'string', 'invalid subdomain');
    const html = await (
      await fetch(`${ENV.get('SERVER_URL')}/embed/${subdomain}`)
    ).text();
    const withAbsoluteImagePaths = html.replaceAll(
      '/_next/image',
      `${ENV.get('SERVER_URL')}/_next/image`
    );
    const { document } = new JSDOM(withAbsoluteImagePaths).window;
    for (const script of document.querySelectorAll('script')) {
      script.remove();
    }
    const body = document.getElementById('__next');
    invariant(body, 'body not found');
    if (styles) {
      const preflight = req.query.preflight === 'true';
      const stylesEl = document.createElement('style');
      stylesEl.innerHTML = generateStyles(body.innerHTML, preflight);
      body.prepend(stylesEl);
    }

    res
      .status(200)
      .setHeader(
        'Cache-control',
        's-maxage=1, stale-while-revalidate=3154000000'
      )
      .setHeader('Accept-Encoding', 'gzip')
      // todo: only allow cors for registered hosts?
      .setHeader('Access-Control-Allow-Origin', '*')
      .send(body?.innerHTML);
  } catch (e) {
    console.error('Failed to render', e);
  }
}
