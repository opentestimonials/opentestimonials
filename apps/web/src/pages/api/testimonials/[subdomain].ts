import {
  AirtableAdapter,
  getTestimonials,
} from '@/server/testimonials/getTestimonials';
import { NextApiRequest, NextApiResponse } from 'next';

// http://localhost:3000/_next/image?url=https%3A%2F%2Fdl.airtable.com%2F.attachments%2F485fce6220e49def51ef98e730bd07a6%2Fe93adf1f%2Fdebbie-obrien.fd2a06311039f2d0bf1828d36c209714.jpg%3Fts%3D1657081653%26userId%3DusrSS6RbKneR5ilXA%26cs%3Dba801e47cbedc442&w=96&q=75
// https://dl.airtable.com/.attachments/485fce6220e49def51ef98e730bd07a6/e93adf1f/debbie-obrien.fd2a06311039f2d0bf1828d36c209714.jpg?ts=1657090660&userId=usrSS6RbKneR5ilXA&cs=6e145968039d40b3
// https://dl.airtable.com/.attachments/485fce6220e49def51ef98e730bd07a6/e93adf1f/debbie-obrien.fd2a06311039f2d0bf1828d36c209714.jpg?ts=1657081653&userId=usrSS6RbKneR5ilXA&cs=ba801e47cbedc442&w=96&q=75

function mergeSearchParams(url: string, obj: URLSearchParams) {
  const searchParams = new URLSearchParams(url.split('?')[1]);
  for (const [key, value] of obj) {
    searchParams.set(key, value);
  }
  return `${url.split('?')[0]}?${searchParams.toString()}`;
}

function getNextJsImageUrl(url: string, options: Record<string, string>) {
  const _url = new URL(url);
  const result = new URL(_url.pathname, _url.host);
  result.search = mergeSearchParams(url, _url.searchParams);
  for (const [key, value] of Object.entries(options)) {
    result.searchParams.set(key, value);
  }
  return `/_next/image?url=${encodeURI(result.toString())}`;
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const subdomain = String(req.query.subdomain);
    const testimonials = await getTestimonials(AirtableAdapter, {
      subdomain,
    });

    res
      .status(200)
      .setHeader(
        'Cache-control',
        's-maxage=1, stale-while-revalidate=3154000000'
      )
      .json({ data: testimonials });
  } catch (e) {
    console.dir(e, { depth: null });
    res.status(500).json({ error: e });
  }
}
