import { NextApiRequest, NextApiResponse } from 'next';

const code = `
function main() {
  const subdomain = document.currentScript.getAttribute('subdomain')
  if (!subdomain) {
    throw new Error(\`Add a subdomain. eg. <script subdomain="demo" />\`)
  }
  const iframe = document.createElement('iframe')
  iframe.src = \`http://opentestimonials.com/embed/expandable/\${subdomain}?noscroll=true&showCollapse=false\`
  iframe.id = "opentestimonials-iframe"
  iframe.frameBorder = "0"
  iframe.width = "100%"
  iframe.style = "min-height: min(100vh, 100%); box-sizing: border-box"
  document.currentScript.insertAdjacentElement("beforebegin", iframe)
  window.addEventListener("message", (e) => {
    if (e.data.type === "expand-testimonials") {
      iframe.style.height = e.data.scrollHeight + "px";
    } else if (e.data.type === 'unexpand-testimonials') {
      iframe.style.height = 'auto'
      iframe.scrollIntoView({
        behavior: 'smooth',
      });
    }
  })
}
main()`;

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  res
    .status(200)
    .setHeader(
      'Cache-control',
      's-maxage=60, stale-while-revalidate=3154000000'
    )
    .setHeader('Accept-Encoding', 'gzip')
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Content-Type', 'application/javascript')
    .send(code);
}
