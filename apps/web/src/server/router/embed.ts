import { prisma } from '@/server/db/client';
import { filterValidTestimonials, Testimonial } from '@/validators/testimonial';
import { TRPCError } from '@trpc/server';
import Airtable from 'airtable';
import { z } from 'zod';
import { createRouter } from './context';

interface TestimonialsAdapter {
  getTestimonials: (options: EmbedOptions) => Promise<Testimonial[]>;
}

export const AirtableAdapter: TestimonialsAdapter = {
  getTestimonials: async (options: EmbedOptions) => {
    const collection = await prisma.collection.findUnique({
      where: {
        subdomain: options.subdomain,
      },
    });
    if (!collection) {
      throw new TRPCError({ code: 'NOT_FOUND' });
    }
    const { airtableApiKey, airtableBase, airtableTable } = collection;
    if (!airtableApiKey || !airtableBase || !airtableTable) {
      console.error('Missing Airtable API key, base, or table');
      throw new TRPCError({ code: 'NOT_FOUND' });
    }
    const base = new Airtable({ apiKey: airtableApiKey }).base(airtableBase);
    const rawRecords = (
      await base(airtableTable)
        .select({
          maxRecords: 100,
          view: 'Grid view',
          cellFormat: 'json',
        })
        .all()
    ).map((r) => r._rawJson);

    return filterValidTestimonials(rawRecords).map((t) => ({
      id: t.id,
      created_at: t.createdTime,
      name: t.fields['Name'],
      quote: t.fields['Quote'],
      source_url: t.fields['Source URL'],
      company_url: t.fields['Company URL'],
      profile_url: t.fields['Profile URL'],
      profile_picture_url: t.fields['Profile Picture']?.[0]?.url,
      verified: t.fields['Verified'],
      title_or_company: t.fields['Title / Company'],
    }));
  },
};

export async function airtableAdapter(options: EmbedOptions) {
  const collection = await prisma.collection.findUnique({
    where: {
      subdomain: options.subdomain,
    },
  });
  if (!collection) {
    throw new TRPCError({ code: 'NOT_FOUND' });
  }
  const { airtableApiKey, airtableBase, airtableTable } = collection;
  if (!airtableApiKey || !airtableBase || !airtableTable) {
    console.error('Missing Airtable API key, base, or table');
    throw new TRPCError({ code: 'NOT_FOUND' });
  }
  const base = new Airtable({ apiKey: airtableApiKey }).base(airtableBase);
  const rawRecords = (
    await base(airtableTable)
      .select({
        maxRecords: 100,
        view: 'Grid view',
        cellFormat: 'json',
      })
      .all()
  ).map((r) => r._rawJson);

  const validTestimonials = filterValidTestimonials(rawRecords);
  const result = [];
  for (const testimonial of validTestimonials) {
    result.push({
      id: testimonial.id,
    });
  }
  return result;
}

export async function getTestimonials(
  adapter: TestimonialsAdapter,
  options: EmbedOptions
) {
  return adapter.getTestimonials(options);
}

const embedRouterValidator = z.object({
  subdomain: z.string(),
  pathname: z.string().optional(),
});
type EmbedOptions = z.infer<typeof embedRouterValidator>;

export const embedRouter = createRouter().query('testimonials', {
  input: embedRouterValidator,
  async resolve({ input }) {
    // const testimonials = await airtableAdapter(input);
    const testimonials = getTestimonials(AirtableAdapter, input);
    return testimonials;
  },
});
