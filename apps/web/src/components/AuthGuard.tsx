import { useSession } from 'next-auth/react';
import { useRouter } from 'next/router';
import Script from 'next/script';
import { useEffect } from 'react';

export default function AuthGuard(props: { callbackUrl?: string }) {
  const session = useSession();
  const router = useRouter();

  useEffect(() => {
    if (session.status === 'unauthenticated') {
      const url = new URL('/login', window.origin);
      if (props.callbackUrl) {
        url.searchParams.set('callbackUrl', props.callbackUrl);
      }
      router.replace(url);
    }
  }, [session]);

  return (
    <>
      <Script
        id="auth-guard-script"
        dangerouslySetInnerHTML={{
          __html: `window.signedIn = window.localStorage.getItem('next-auth.signed-in');
          if (typeof signedIn !== 'undefined') {
            if (signedIn !== 'true') {
              window.location.replace('/login');
            }
          }`,
        }}
        strategy="beforeInteractive"
      />
    </>
  );
}
